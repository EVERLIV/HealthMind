export class DeepSeekVisionService {
  private apiKey: string;
  private baseUrl = 'https://api.deepseek.com/v1';

  constructor(apiKey: string) {
    this.apiKey = apiKey;
  }

  async analyzeHealthImage(imageBase64: string, mimeType: string = 'image/jpeg', question: string): Promise<string> {
    try {
      // Validate and normalize MIME type
      const validMimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      let validatedMimeType = mimeType?.toLowerCase();
      
      if (!validatedMimeType || !validMimeTypes.includes(validatedMimeType)) {
        console.log('Invalid MIME type:', mimeType, 'defaulting to image/jpeg');
        validatedMimeType = 'image/jpeg';
      }

      const response = await fetch(`${this.baseUrl}/chat/completions`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: "deepseek-vl-7b-chat",
          messages: [
            {
              role: "system",
              content: `–í—ã - –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥ —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. 
              –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ—Å—å –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∫–æ–∂–Ω—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º.
              
              –í–ê–ñ–ù–û:
              1. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∫–æ–∂–Ω—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π
              2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã (–≤ –ø–æ—Ä—è–¥–∫–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏)
              3. –û–ø–∏—à–∏—Ç–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏ —Å–∏–º–ø—Ç–æ–º—ã
              4. –î–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
              5. –£–∫–∞–∂–∏—Ç–µ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤—Ä–∞—á—É
              
              –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ: –≤—ã—Å—ã–ø–∞–Ω–∏—è, –ø—è—Ç–Ω–∞, —Ä–æ–¥–∏–Ω–∫–∏, –ø–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏—è, —à–µ–ª—É—à–µ–Ω–∏—è, 
              –≤–æ—Å–ø–∞–ª–µ–Ω–∏—è, –Ω–æ–≤–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –∫–æ–∂–∏, —Ç–µ–∫—Å—Ç—É—Ä—ã.`
            },
            {
              role: "user",
              content: [
                {
                  type: "text",
                  text: question || `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–∂–∏/–∫–æ–∂–Ω–æ–≥–æ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è:
                  
                  1. –ß—Ç–æ –≤—ã –≤–∏–¥–∏—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏? (–ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
                  2. –ö–∞–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã? (—Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é)
                  3. –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?
                  4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–µ—á–µ–Ω–∏—é –∏ —É—Ö–æ–¥—É
                  5. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ —Å—Ä–æ—á–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å?
                  
                  –î–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑.`
                },
                {
                  type: "image_url",
                  image_url: {
                    url: `data:${validatedMimeType};base64,${imageBase64}`,
                    detail: "high"
                  }
                }
              ]
            }
          ],
          max_tokens: 1500,
          temperature: 0.2,
        }),
      });

      if (!response.ok) {
        throw new Error(`DeepSeek Vision API error: ${response.status} - ${response.statusText}`);
      }

      const data = await response.json();
      const analysis = data.choices[0]?.message?.content || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.";
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
      return `${analysis}

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –î–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–æ—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ª–µ—á–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥—É –æ—á–Ω–æ.`;
    } catch (error) {
      console.error("Error analyzing health image with DeepSeek Vision:", error);
      
      // –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      return `üì∏ **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞**

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ:

üîç **–û–ø–∏—Å–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Ç–µ–∫—Å—Ç–æ–º:**
- –ì–¥–µ –∏–º–µ–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –∫–æ–∂–µ?
- –ö–∞–∫ –¥–æ–ª–≥–æ —ç—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è?
- –ï—Å—Ç—å –ª–∏ –∑—É–¥, –±–æ–ª—å –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–∏–º–ø—Ç–æ–º—ã?
- –ò–∑–º–µ–Ω—è–ª—Å—è –ª–∏ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º?

üíä **–û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É –∑–∞ –∫–æ–∂–µ–π:**
- –ò–∑–±–µ–≥–∞–π—Ç–µ —Ä–∞—Å—á–µ—Å—ã–≤–∞–Ω–∏—è
- –°–æ–¥–µ—Ä–∂–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –≤ —á–∏—Å—Ç–æ—Ç–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—è–≥–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≥–∏–≥–∏–µ–Ω—ã
- –ò–∑–±–µ–≥–∞–π—Ç–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è —Å–æ–ª–Ω—Ü–∞ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω—É—é –∑–æ–Ω—É

‚ö†Ô∏è **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É –µ—Å–ª–∏:**
- –û–±–ª–∞—Å—Ç—å –±—ã—Å—Ç—Ä–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
- –ü–æ—è–≤–∏–ª–∞—Å—å –±–æ–ª—å –∏–ª–∏ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ
- –ò–∑–º–µ–Ω–∏–ª—Å—è —Ü–≤–µ—Ç –∏–ª–∏ —Ñ–æ—Ä–º–∞
- –ü–æ–≤—ã—Å–∏–ª–∞—Å—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Ç–µ–∫—Å—Ç–æ–º - —è —Å–º–æ–≥—É –¥–∞—Ç—å –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã!`;
    }
  }
}

export default DeepSeekVisionService;